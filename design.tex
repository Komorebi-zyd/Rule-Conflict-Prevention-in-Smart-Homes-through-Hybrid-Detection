\section{Design}

\subsection{Overview}
\begin{figure*}[htbp]
	\centering
	\includegraphics[width=\textwidth]{figure/overall_design.png}
	\caption{Overall Architecture of Our Approach}
	\label{overall_design}
\end{figure*}
%æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿç”¨äºŽé‡‡ç”¨é™æ€ä¸ŽåŠ¨æ€ç»“åˆçš„æ–¹å¼æ£€æµ‹éšå«åœ¨è§„åˆ™äº¤äº’ä¸­çš„è§„åˆ™å†²çªï¼Œå¹¶ä¸”åœ¨è§„åˆ™å†²çªå‘ç”Ÿä¹‹å‰è‡ªåŠ¨æ‰§è¡Œå®šåˆ¶åŒ–çš„å†²çªå¤„ç†ç­–ç•¥ï¼Œé¿å…è§„åˆ™å†²çªçš„çœŸå®žå‘ç”Ÿï¼Œå¹¶ä¸”æ”¯æŒã€‚æ ¹æ®å›¾ç‰‡Fig.\ref{overalldesign}ï¼Œæˆ‘ä»¬çš„æ–¹æ³•ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š1) é™æ€åˆ†æžï¼›2) åŠ¨æ€æ£€æµ‹å’Œå†²çªå¤„ç†ã€‚
A complete system is designed that detects rule conflicts hidden in rule interactions by combining static and dynamic approaches, and automatically executes customized conflict resolution strategies before conflicts occur to prevent actual conflicts. According to Fig.\ref{overall_design}, our method mainly includes two steps: 1) Static analysis; 2) Dynamic detection and conflict resolution.

%åœ¨ç¬¬ä¸€ä¸ªæ­¥éª¤ä¸­åŒ…å«äº†è§„åˆ™å»ºæ¨¡æ¨¡å—ã€å½¢å¼åŒ–åˆ†æžæ¨¡å—ã€é™æ€è§„åˆ™å†²çªæ£€æµ‹æ¨¡å—ä¸Žå†²çªå¤„ç†ç­–ç•¥ç”Ÿæˆæ¨¡å—ã€‚æ™ºèƒ½å®¶å±…ç³»ç»Ÿä¸­çš„è‡ªåŠ¨åŒ–è§„åˆ™å°†è¢«é‡æ–°å»ºæ¨¡ä»¥å®žçŽ°å¯¹å®¶åº­çŽ¯å¢ƒåŒºåŸŸçš„åŒºåˆ†ã€‚ä¹‹åŽï¼Œå½¢å¼åŒ–åˆ†æžå°†åŸºäºŽæ–°çš„è§„åˆ™æ¨¡åž‹ï¼Œä»Žè€Œæå–æ‰€æœ‰ç±»åž‹çš„è§„åˆ™äº¤äº’ä¸Žå¯¹åº”çš„è§„åˆ™äº¤äº’åˆ†æžæ•°æ®ã€‚ç”¨æˆ·çš„å®žä½“å®‰å…¨é…ç½®å°†è¢«åº”ç”¨äºŽè§„åˆ™å†²çªæ£€æµ‹æ¨¡å—ï¼Œç”¨äºŽå°†è§„åˆ™å†²çªä»Žè§„åˆ™äº¤äº’é›†åˆä¸­æå–å‡ºæ¥ã€‚è€ƒè™‘åˆ°ä¸€ä¸ªè§„åˆ™äº¤äº’æ˜¯å¦å±žäºŽè§„åˆ™å†²çªçš„å®šä¹‰æ¯”è¾ƒä¸»è§‚ï¼Œæˆ‘ä»¬æä¾›ç”¨æˆ·é…ç½®æŽ¥å£ï¼Œå…¶ä¸­å½¢å¼åŒ–åˆ†æžæ¨¡å—æå–çš„è§„åˆ™äº¤äº’åˆ†æžæ•°æ®å°†ä¼šä»¥è‡ªç„¶è¯­è¨€å½¢å¼å±•ç¤ºç»™ç”¨æˆ·ï¼Œä»¥è¾…åŠ©ç”¨æˆ·å®Œæˆå¯¹äºŽè§„åˆ™å†²çªçš„åˆ¤æ–­ã€‚æœ€ç»ˆè§„åˆ™å†²çªå¤„ç†ç­–ç•¥ç”Ÿæˆæ¨¡å—å°†ä¼šä¸ºå½¢æˆçš„è§„åˆ™å†²çªé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ ç”Ÿæˆå®šåˆ¶åŒ–çš„è§„åˆ™å†²çªå¤„ç†ç­–ç•¥ã€‚
The first step includes a rule modeling module, a formal analysis module, a static rule conflict detection module, and a resolution strategy generation module. The rules in the smart home system will be remodeled to achieve differentiation of environment zones. Afterwards, formal analysis will be based on the new rule model to extract all types of rule interactions along with corresponding rule interaction analysis data. The entity security configuration will be applied to the rule conflict detection module to extract rule conflicts from the set of rule interactions. Considering that the definition of whether a rule interaction constitutes a rule conflict is relatively subjective, system provides a user configuration interface through which the rule interaction analysis data extracted by formal analysis module will be displayed to the user in natural language to assist the user in determining rule conflicts. Finally, for each element in the formed set of rule conflicts, the resolution strategy generation module will generate a customized rule conflict resolution strategy.

%åœ¨ç¬¬äºŒä¸ªæ­¥éª¤ä¸­åŒ…å«äº†è§„åˆ™äº‹ä»¶ç›‘å¬æ¨¡å—ï¼Œæ–­è¨€éªŒè¯æ¨¡å—ä¸Žå‘½ä»¤ç”Ÿæˆæ¨¡å—ï¼Œé™¤æ­¤ä¹‹å¤–æ™ºèƒ½å®¶å±…ç³»ç»Ÿï¼ˆè¿™é‡Œä½¿ç”¨çš„æ˜¯Home Assistantï¼‰ä¸­çš„ä»£ç æ’è£…æ¨¡å—å°†ä¼šè¾…åŠ©å®ŒæˆåŠ¨æ€çš„è§„åˆ™å†²çªæ£€æµ‹ä¸Žè§„åˆ™å†²çªé¢„é˜²ã€‚è§„åˆ™ç›‘å¬æ¨¡å—å°†ä¼šå®žæ—¶ç›‘å¬è§„åˆ™æ‰§è¡Œä¿¡æ¯ï¼Œå½“æœ‰è§„åˆ™ä¸€æ¡è§„åˆ™åœ¨è¢«è§¦å‘ï¼Œåœ¨æ¡ä»¶æ£€æŸ¥å‰åŽæ—¶æœºï¼Œä¼šå°†ç›¸å…³ä¿¡æ¯å‘é€ç»™æ–­è¨€æ£€æµ‹æ¨¡å—ã€‚æ–­è¨€æ£€æµ‹æ¨¡å—å°†ä¼šæ ¹æ®è¿‡åŽ»è§„åˆ™æ‰§è¡Œäº‹ä»¶ä¸Žå½“å‰æ­£åœ¨æ‰§è¡Œçš„è§„åˆ™ä¿¡æ¯ã€ç›¸å…³è®¾å¤‡çŠ¶æ€ä¿¡æ¯è¿›è¡Œæ–­è¨€æ£€æµ‹ï¼Œåˆ¤æ–­è§„åˆ™å†²çªæ˜¯å¦çœŸå®žå‘ç”Ÿã€‚å¦‚æžœæ˜¯ï¼Œåˆ™å‘½ä»¤ç”Ÿæˆæ¨¡å—å°†ä¼šæ ¹æ®å½“å‰å³å°†å‘ç”Ÿçš„è§„åˆ™å†²çªä¿¡æ¯ï¼Œæ ¹æ®é™æ€æ£€æµ‹ä¸­çš„è§„åˆ™å†²çªå¤„ç†ç­–ç•¥ç”Ÿæˆæ‰§è¡Œå‘½ä»¤ï¼Œäº¤ç”±ä»£ç æ’è£…æ¨¡å—å¼ºåˆ¶æ‰§è¡Œã€‚
In the second step, a rule event listener module, an assertion verification module, and a command generation module are included. In addition, the code instrumentation module in the smart home system for example Home Assistant will assist in dynamic rule conflict detection and prevention. The rule event listener module will monitor rule execution information in real time. When a rule is triggered, before and after condition checking, it will send the relevant information to the assertion checking module. The assertion check module will then perform assertion checks based on historical rule execution events, the information of the currently executing rule, and related device status information, to determine whether a rule conflict has actually occurred. If so, the command generation module will generate execution commands based on the current rule conflict information about to occur and the rule conflict resolution strategy from static detection, which will be enforced by the code instrumentation module.

\subsection{Static Phase}

\subsubsection{Rule Modeling}

%\begin{figure}[htbp]
%	\centering
%	\includegraphics[width=0.4\textwidth]{figure/classification_observation.png}
%	\caption{Rule Interaction Pattern}
%	\label{classification_observation}
%\end{figure}

%åœ¨æ­£å¼ä»‹ç»é™æ€æ­¥éª¤ä¹‹å‰ï¼Œéœ€è¦ä»‹ç»ä¸€ä¸‹æœ¬æ–¹æ¡ˆå¯¹è§„åˆ™äº¤äº’ä¸Žè§„åˆ™å†²çªçš„åˆ†ç±»ã€‚æ ¹æ®ä¹‹å‰çš„è§‚å¯Ÿæˆ‘ä»¬å°†è§„åˆ™ä¹‹é—´çš„äº¤äº’ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å½’çº³ï¼šä¸€æ¡è§„åˆ™çš„æ‰§è¡Œç»“æžœå¯¹é›¶ä¸€æ¡è§„åˆ™çš„è§¦å‘å™¨ã€æ¡ä»¶ä¸ŽåŠ¨ä½œäº§ç”Ÿç›´æŽ¥ä¸Žé—´æŽ¥å½±å“ã€‚ç”±æ­¤æˆ‘ä»¬å¯ä»¥è®²è§„åˆ™äº¤äº’è¿›è¡Œä»¥ä¸‹åˆ†ç±»ï¼šTrigger Interactionï¼ŒCondition Interactionï¼ŒAction Interactionï¼ŒIndirect Trigger Interactionï¼ŒIndirect Condition Interactionï¼ŒIndirect Action Interactionã€‚åŒæ—¶ä¹Ÿå¯ä»¥å¾—åˆ°å…­ç§è§„åˆ™å†²çªåˆ†ç±»ï¼šTrigger Conflictï¼ŒCondition Conflictï¼ŒAction Conflictï¼ŒIndirect Trigger Conflictï¼ŒIndirect Condition Conflictï¼ŒIndirect Action Conflictã€‚
Before formally introducing the static step, it is necessary to the classification of rule interactions and rule conflicts for this approach. Based on previous observations Fig.\ref{classification_observation}, we summarize the interactions among rules using the following method: the execution result of one rule can have direct and indirect impacts on the triggers, conditions, and actions of another rule. Thus, we can classify rule interactions as follows: Trigger Interaction, Condition Interaction, Action Interaction, Indirect Trigger Interaction, Indirect Condition Interaction, and Indirect Action Interaction. At the same time, six categories of rule conflicts can be identified: Trigger Conflict, Condition Conflict, Action Conflict, Indirect Trigger Conflict, Indirect Condition Conflict, and Indirect Action Conflict.

%æ™ºèƒ½å®¶å±…ç³»ç»Ÿä¸­çš„è§„åˆ™é…ç½®é€šå¸¸ä»¥é™æ€æ–‡ä»¶å­˜å‚¨ï¼Œå…¶ä¸­å¯ä»¥æå–å¾—åˆ°ä¸€æ¡è§„åˆ™çš„è§¦å‘å™¨ã€æ¡ä»¶ä¸ŽåŠ¨ä½œå±žæ€§ï¼Œå¯ä»¥å¿«é€Ÿå»ºæ¨¡ä¸º$\lanle T,C,A $\rangle$æ¨¡åž‹ï¼Œä½†æ˜¯ä»¥ä¸Šæ•°æ®ä¸è¶³ä»¥æ”¯æŒå¯¹æ™ºèƒ½å®¶å±…ç³»ç»Ÿä¸­ä¸åŒå®¶åº­åŒºåŸŸçš„ä¾§é¢é€šé“çš„å½±å“çš„æ£€æµ‹ï¼Œå¦‚ä¸åŒè§„åˆ™å¯¹å§å®¤æ¸©åº¦çš„å½±å“å¼•å‘çš„è§„åˆ™äº¤äº’ï¼Œæˆ–è€…ä¸åŒè§„åˆ™å¼€å¯äº†é«˜åŠŸè€—è®¾å¤‡ï¼Œå¯¼è‡´å®¶åº­ç”¨ç”µåŠŸçŽ‡æå‡ï¼Œè§¦å‘ç›¸å…³çš„è§„åˆ™æ¥èŠ‚çº¦ç”¨ç”µç­‰ï¼Œå› æ­¤éœ€è¦å¼•å…¥æ–°çš„å±žæ€§$E$ã€‚å®šä¹‰$E=[e^1, e^2,\dots]$ï¼Œ$e^i=(area, channel, trend)$ã€‚å…¶ä¸­$area$è¡¨ç¤ºç®€ä»‹é€šé“çš„åŒºåŸŸç‰¹å¾ï¼Œå¦‚åŽ¨æˆ¿ã€å®¢åŽ…æˆ–æ•´ä¸ªå®¶åº­ç­‰ï¼›$channel$è¡¨ç¤ºä¾§é¢é€šé“åç§°ï¼Œå¦‚æ¸©åº¦ã€æ¹¿åº¦ã€å…‰ç…§å¼ºåº¦ç­‰ï¼›$trend$è¡¨ç¤ºè¯¥ä¾§é¢å½±å“çš„å½±å“è¶‹åŠ¿ï¼Œå¦‚å‡é«˜ã€é™ä½Žç­‰ã€‚å¯¹äºŽä¸€æ¡è§„åˆ™çš„æ¡ä»¶æ¥è¯´ï¼Œå¦‚æžœ$e$æ˜¯â€œåŽ¨æˆ¿æ¸©åº¦å‡é«˜â€ï¼Œåˆ™è¡¨ç¤ºå¦‚æžœå…¶ä»–è§„åˆ™çš„æ‰§è¡Œç»“æžœå¯èƒ½å¯¼è‡´åŽ¨æˆ¿æ¸©åº¦å‡é«˜ï¼Œåˆ™ä¼šä¿ƒè¿›å½“å‰è§„åˆ™æ¡ä»¶çš„æ»¡è¶³ã€‚å¯¹äºŽä¸€æ¡è§„åˆ™çš„æ‰§è¡ŒåŠ¨ä½œæ¥è¯´ï¼Œå¦‚æžœ$e$æ˜¯â€œåŽ¨æˆ¿æ¸©åº¦å‡é«˜â€ï¼Œåˆ™è¡¨ç¤ºå½“å‰è§„åˆ™æ‰§è¡ŒåŽå¯èƒ½ä¼šä¿ƒè¿›åŽ¨æˆ¿æ¸©åº¦å‡é«˜ã€‚å±žæ€§$E$å°†æ ¹æ®ç”¨æˆ·çœŸå®žçš„å®¶åº­æƒ…å†µä¸Žç›¸å…³è§„åˆ™ç¡®å®šï¼Œä¾‹å¦‚å¦‚æžœä¸€ä¸ªå®¶åº­ä¸­æ²¡æœ‰ä»»ä½•æœ‰å…³â€œæ¹¿åº¦â€çš„è§„åˆ™ï¼Œåˆ™ä¸éœ€è¦è®¾ç½®$channel$ä¸ºâ€œæ¹¿åº¦â€çš„å±žæ€§$e$ã€‚ç”±æ­¤ä¸€æ¡è§„åˆ™å¯ä»¥è¢«é‡æ–°å»ºæ¨¡ä¸ºä»¥ä¸‹å½¢å¼$R=\langle T,C,A,E\rangle $ æˆ– $R=\langle T_1,C_1,A_1,R_T,E_C,E_A \rangle$ï¼Œ è¢«ç§°ä¸º TCAE æ¨¡åž‹ã€‚
In smart home systems, rule configuration is usually stored as static files, from which the triggers, conditions, and action attributes of a rule can be extracted, and quickly modeled as a $\langle T,C,A \rangle$ model. However, the above data is insufficient to support the detection of the effects of side channels in different home areas within smart home systems. For example, rule interactions may be caused by different rules affecting the bedroom temperature, or by different rules turning on high-power devices, leading to an increase in the household's power consumption and subsequently triggering related rules to conserve electricity. Therefore, a new attribute $E$ needs to be introduced. $E$ is defined as$E=[e^1, e^2,\dots]$ and $e^i=(area, channel, trend)$, where $area$ indicates the spatial characteristics of the channel, such as the kitchen, living room, or the whole home; $channel$ indicates the name of the other channel which rules may impact each other, such as temperature, humidity, illuminance and so on; and $trend$ indicates the direction of the influence of the other channel, such as an increase and decrease. For the trigger/condition of a rule, if $e$ is $\langle kitchen, temperature, increases\rangle$, it means that if the execution results of other rules may lead to an increase in kitchen temperature, then the trigger/condition of the current rule is more likely to be met. For the action execution of a rule, if $e$ is $\langle kitchen, temperature, increases\rangle$, it means that the execution of the current rule may promote an increase in kitchen temperature. The attribute $E$ will be determined based on the user's actual home situation and the related rules. For example, if there are no rules concerning "humidity" in a home, then there is no need to set the $channel$ attribute of $e$ as "humidity". Thus, a rule can be re-modeled in the following form: $R=\langle T,C,A,E\rangle $ or $R=\langle T,C,A,E_T,E_C,E_A \rangle$ which called TCAE model.

\subsubsection{Formal Analysis}

\begin{table*}[htbp]
	\begin{center}
		\caption{Formal Analysis Expression}
		\label{Formal_Analysis_Expression}
		\begin{tabular}[width=0.95\textwidth]{c|c} 
			\hline
			\textbf{Classification} & \textbf{Expression}\\
			\hline
			\text{Trigger Interaction} & $(\exists a_{1}\in A_{1})\wedge(a_{1}\rightarrow T_{2})$ \\
			\hline
			\text{Condition Interaction} & $\left((A_{1}\nrightarrow C_{2})\wedge\left((T_{1}\neq T_{2})\wedge(R_{1}\neq R_{2})\right)\right)\vee\left((A_{1}\to\mathcal{C}_{2})\wedge\left((T_{1}\neq T_{2})\wedge(R_{1}\neq R_{2})\right)\right)$ \\
			\hline
			\text{Action Interaction} & $(\exists a_{1}\in A_{1})\wedge(\exists a_{2}\in A_{2})\wedge(a_{1}\perp a_{2})$ \\
			\hline
			\text{Indirect Trigger Interaction} & $(\exists a_{1}\in A_{1})\wedge\left(E_{a_{1}}=E_{T_{1}}\right)$ \\
			\hline
			\text{Indirect Condition Interaction} & $\left(\left(E_{A_{1}}\perp E_{C_{2}}\right)\vee\left(E_{A_{1}}=E_{C_{2}}\right)\right)\wedge\left(R_{1}\neq R_{2}\right)$ \\
			\hline
			\text{Indirect Action Interaction} & $(\exists a_{1}\in A_{1})\wedge(\exists a_{2}\in A_{2})\wedge\left(D_{a_{1}}\neq D_{a_{2}}\right)\wedge\left(E_{a_{1}}\perp E_{a_{2}}\right)$ \\
			\hline
		\end{tabular}
	\end{center}
\end{table*}

%æŒ‰ç…§TCAæ¨¡åž‹æ¥å®žçŽ°è§„åˆ™å†²çªåˆ†ç±»ï¼Œè®¾æœ‰è§„åˆ™ $R=\langle T_1,C_1,A_1,E_T,E_C,E_A \rangle$ å’Œ ð‘…â‚‚=(ð‘‡â‚‚, ð¶â‚‚, ð´â‚‚, ð¸(ð‘‡â‚‚), ð¸(ð¶â‚‚), ð¸(ð´â‚‚)) è¢«ç”¨æ¥è¡¨ç¤ºåœ¨åŒä¸€ç³»ç»Ÿä¸­è®¾ç½®çš„ä¸¤ä¸ªè‡ªåŠ¨åŒ–è§„åˆ™ï¼ŒTã€Cã€Aã€Eåˆ†åˆ«è¡¨ç¤ºå¯¹åº”çš„å±žæ€§åˆ—è¡¨ã€‚æœ¬æ–‡ä½¿ç”¨$\rightarrow$è¡¨ç¤ºä½¿è§¦å‘å™¨è§¦å‘æˆ–è€…ä½¿æ¡ä»¶æ»¡è¶³ï¼Œ$nrightarrow$è¡¨ç¤ºä½¿æ¡ä»¶ç¦æ­¢ã€‚å¯¹äºŽchannelå±žæ€§ï¼Œ$\bot$è¡¨ç¤ºä¸¤ä¸ªchannelå±žæ€§ï¼Œä»–ä»¬çš„areaå’Œchannelç›¸åŒï¼Œä½†æ˜¯trendç›¸åï¼ˆå¦‚åŽ¨æˆ¿æ¸©åº¦å‡é«˜ä¸ŽåŽ¨æˆ¿æ¸©åº¦é™ä½Žï¼‰ï¼Œæˆ–è€…è¡¨ç¤ºä¸¤ä¸ªactionå†²çªï¼ˆå¦‚å¼€ç©ºè°ƒä¸Žå…³ç©ºè°ƒï¼‰ï¼Œ=è¡¨ç¤ºå­˜åœ¨ä¸¤ä¸ªchannelå±žæ€§ï¼Œä»–ä»¬çš„ areaï¼Œ channelå’Œtrendç›¸åŒï¼Œæˆ–è€…ä¸¤ä¸ªç›¸åŒçš„è§¦å‘å™¨ã€åˆ¤æ–­æ¡ä»¶ã€‚
According to the TCA model for rule conflict classification, let rule $R_1=\langle T_1,C_1,A_1,E_{T_1},E_{C_1},E_{A_1} \rangle$ and rule  $R_2=\langle T_2,C_2,A_2,E_{T_2},E_{C_2},E_{A_2} \rangle$ be to represent two automation rules set in the same system, where T, C, A, and E respectively represent the corresponding attribute. This paper uses $\rightarrow$ to indicate that a trigger is activated or a condition is met, and $\nrightarrow$ to indicate that a condition is prohibited.$\bot$ denotes that the two channel attributes have the same area and channel but opposite trends (for example, rising kitchen temperature versus falling kitchen temperature), or it indicates that two actions are in conflict (such as turning on the air conditioner versus turning it off), while "=" indicates that the two channel attributes have the same area, channel, and trend, or that there are two identical triggers or conditions.

%å½¢å¼åŒ–åˆ†æžæ¨¡å—ä¼šéåŽ†æ¯ä¸€æ¡è§„åˆ™æ¨¡åž‹ï¼Œç„¶åŽè¿›è¡Œè¡¨è¾¾å¼éªŒè¯ï¼Œå¦‚æžœè¡¨è¾¾å¼æ»¡è¶³åˆ™è¡¨ç¤ºä¸¤æ¡è§„åˆ™æ»¡è¶³å¯¹åº”çš„è§„åˆ™äº¤äº’åˆ†ç±»ã€‚è§„åˆ™å†²çªæ˜¯è§„åˆ™äº¤äº’çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œè¯¥è¡¨è¾¾å¼åªèƒ½ç­›é€‰å‡ºäº¤äº’çš„è§„åˆ™ï¼Œå¯¹äºŽä¸€ä¸ªè§„åˆ™äº¤äº’æ˜¯å¦å±žäºŽè§„åˆ™å†²çªå¯¹éœ€è¦è¿›ä¸€æ­¥çš„æ£€æµ‹ã€‚å…·ä½“çš„è¡¨è¾¾å¼å¦‚Table.\ref{Formal_Analysis_Expression}ç”±æ­¤å½¢å¼åŒ–åˆ†æžæ¨¡å—èƒ½å¤Ÿåˆ†æžå¾—åˆ°å…·ä½“çš„è§„åˆ™äº¤äº’åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†æ‰€æœ‰è§„åˆ™äº¤äº’ä¸Žäº¤äº’æ¨¡å¼ä¿¡æ¯ã€‚
The formal analysis module will traverse each rule model and then expression validation. If an expression is satisfied, it indicates that the two rules meet the corresponding rule interaction classification. Rule conflict is a special case of rule interaction, and that expression can only filter out interacting rules. further detection is required to determine whether a rule interaction constitutes a rule conflict.The formal analysis module can analyze and obtain a specific list of rule interactions, which includes all rule interactions and interaction pattern information.

\subsubsection{Rule Conflict Detection and Resolution Strategy Generation}
%å®žä½“å®‰å…¨é…ç½®æ˜¯ä¸€ä¸ªå®‰å…¨æ•æ„Ÿè®¾å¤‡å®žä½“çš„å®‰å…¨çŠ¶æ€é›†åˆï¼Œç”¨äºŽè¡¨ç¤ºåœ¨æ™ºèƒ½å®¶å±…ç³»ç»Ÿä¸­é‡åˆ°å†²çªæ—¶å€¾å‘äºŽä¿æŒçš„çŠ¶æ€ï¼Œä¾‹å¦‚é—¨åº”è¯¥æ˜¯â€œå…³é—­â€ï¼Œæ¶ˆé˜²å–·æ·‹å¤´åº”è¯¥æ˜¯â€œå¼€å¯â€ã€‚è§„åˆ™å†²çªæ£€æµ‹æ¨¡å—ä¼šå¯¹æ‰€æœ‰è§„åˆ™äº¤äº’åˆ—è¡¨ä¸­çš„å…ƒç´ è¿›è¡Œå®žä½“å®‰å…¨æ£€æŸ¥ï¼Œä»Žè€Œåˆ¤æ–­ä¸€ä¸ªè§„åˆ™äº¤äº’æ˜¯å¦è¿åå®žä½“å®‰å…¨çŠ¶æ€ä»Žè€Œå¼•èµ·å¯èƒ½çš„è§„åˆ™å†²çªã€‚
Entity safety configuration is a set of safety states for a security-sensitive device entity, used to indicate the preferred state to maintain when a conflict occurs in a smart home systemâ€”for example, a door should be "closed" and a fire sprinkler should be "on." The rule conflict detection module performs an entity safety on all elements in the rule interaction list to determine whether a rule interaction violates the entity safety state, potentially causing a rule conflict.

%å…·ä½“çš„æ£€æŸ¥æ–¹æ³•å¦‚ä¸‹ï¼šä¸€ä¸ªè§„åˆ™äº¤äº’å¯¹åŒ…å«ä¸¤æ¡è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„åœ¨è¯¥è§„åˆ™äº¤äº’å®ŒæˆåŽæ˜¯å¦è¿åå®žä½“å®‰å…¨é…ç½®çš„è¦æ±‚ã€‚å› æ­¤å…¶ä¸­çš„æ¯æ¡è§„åˆ™éƒ½è®¾å®šä¸€ä¸ªå®‰å…¨å€¼å‚æ•°$sf$ã€‚å¦‚æžœè§„åˆ™çš„æ‰§è¡Œç»“æžœæ›´å€¾å‘äºŽæ»¡è¶³å®žä½“å®‰å…¨çŠ¶æ€é…ç½®ï¼Œåˆ™$sf$å€¼è¶Šé«˜ï¼Œåä¹‹åˆ™è¶Šä½Žã€‚å…·ä½“çš„$sf$å€¼å¯ä»¥éåŽ†æ‰€æœ‰å®žä½“å®‰å…¨é…ç½®é‡‡ç”¨çº¿æ€§å‡½æ•°è®¡ç®—ï¼Œä¾‹å¦‚ä¸€æ¡è§„åˆ™çš„æ‰§è¡Œç»“æžœæ˜¯å…³é—¨ï¼Œæ›´å€¾å‘æ»¡è¶³å¯¹äºŽå®žä½“â€œé—¨â€çš„å®‰å…¨çŠ¶æ€â€œå…³é—­â€ï¼Œå› æ­¤è¯¥è§„åˆ™çš„$sf$åœ¨åŽŸæœ‰åŸºç¡€ä¸ŠåŠ ä¸€ï¼Œåä¹‹åˆ™å‡ä¸€ï¼Œé»˜è®¤å€¼ä¸ºé›¶ã€‚
The specific inspection method is as follows: a rule interaction includes two rules, and attention should be paid to whether the entity safety configuration requirements are violated after this rule interaction is completed. Therefore, each rule sets a safety value parameter, $sf$. If the execution result of a rule is more inclined to meet the entity safety configuration, the $sf$ value is higher; otherwise, it is lower. The specific $sf$ value can be calculated using a linear function by traversing all the entity safety configurations. For example, if the execution result of a rule is closing a door, which is more in line with the entity safety state "closed" for the entity "door", then the rule's $sf$ is increased by one from the original value, Otherwise, it is decreased by one, with the default value being zero.

%å¯¹äºŽä¸åŒçš„è§„åˆ™äº¤äº’ï¼Œå…¶è§„åˆ™å†²çªçš„åˆ¤å®šæ–¹æ³•ä¸åŒã€‚
%å¯¹äºŽTrigger Interactionå’ŒIndirect Trigger Interactionç±»åž‹çš„è§„åˆ™å†²çªï¼Œé‡ç‚¹è§‚å¯Ÿç¬¬äºŒæ¡è§„åˆ™çš„å®‰å…¨å€¼$sf$æ˜¯å¦å¤§äºŽé›¶ï¼Œå¦‚æžœå°äºŽé›¶åˆ™åˆ¤å®šä¸ºè§„åˆ™å†²çªã€‚
%å¯¹äºŽCondition Interactionå’ŒIndirect Condition Interactionç±»åž‹çš„è§„åˆ™äº¤äº’ï¼Œå¦‚æžœä¸€ä¸ªè§„åˆ™äº¤äº’çš„ç¬¬ä¸€æ¡è§„åˆ™ç¦æ­¢äº†ç¬¬äºŒæ¡è§„åˆ™çš„æ¡ä»¶è€Œä¸”ç¬¬äºŒæ¡è§„åˆ™çš„$sf$å¤§äºŽé›¶ï¼Œåˆ™åˆ¤å®šä¸ºè§„åˆ™å†²çªï¼Œæˆ–è€…ç¬¬ä¸€æ¡è§„åˆ™ä½¿å¾—äº†ç¬¬äºŒæ¡è§„åˆ™çš„æ¡ä»¶å¾—ä»¥æ»¡è¶³è€Œä¸”ç¬¬äºŒæ¡è§„åˆ™çš„$sf$å°äºŽé›¶ï¼Œåˆ™åˆ¤å®šä¸ºè§„åˆ™å†²çªï¼Œè¡¨ç¤ºå› ä¸ºå‰ä¸€æ¡è§„åˆ™çš„å½±å“å¯¼è‡´åŽä¸€æ¡æ›´å€¾å‘äºŽå®žä½“å®‰å…¨çŠ¶æ€çš„è§„åˆ™æ²¡æœ‰è¢«æ‰§è¡Œæˆ–è€…å¯¼è‡´åŽä¸€æ¡ä¸Žå®žä½“å®‰å…¨çŠ¶æ€ç›¸è¿èƒŒçš„è§„åˆ™è¢«æ‰§è¡Œã€‚
%å¯¹äºŽAction Interactionå’ŒIndirect Action Interactionï¼Œå¦‚æžœå…¶åŒ…å«çš„ä¸¤æ¡è§„åˆ™çš„å®‰å…¨å€¼è‹¥æœ‰ä¸€æ¡ä¸ä¸ºé›¶ï¼Œåˆ™åˆ¤å®šä¸ºè§„åˆ™å†²çªã€‚è¿™é‡Œéœ€è¦è€ƒè™‘åœ¨ä¸¤æ¡è§„åˆ™å®‰å…¨å€¼éƒ½å¤§äºŽé›¶æ—¶ï¼Œä¹Ÿä¼šè¢«åˆ¤å®šä¸ºè§„åˆ™å†²çªï¼Œå› ä¸ºåœ¨è¯¥ç±»åž‹çš„è§„åˆ™äº¤äº’çš„åˆ¤å®šä¸­ï¼Œä¸¤æ¡è§„åˆ™çš„æ‰§è¡Œç»“æžœæ˜¯ç›¸è¿èƒŒçš„ï¼Œå¾€å¾€åªæœ‰ä¸€æ¡è§„åˆ™éœ€è¦è¢«æ‰§è¡Œã€‚
For different rule interactions, the method for determining rule conflicts varies. 
\begin{itemize}
	\item For Trigger Interaction and Indirect Trigger Interaction, the focus is on whether the safety value $sf$ of the second rule is greater than zero; if it is less than zero, then it is determined to be a rule conflict.
	\item For Condition Interaction and Indirect Condition Interaction, if the first rule in a rule interaction prohibits the condition of the second rule while the second ruleâ€™s $sf$ is greater than zero, it is determined to be a rule conflict; or if the first rule satisfies the condition of the second rule while the second ruleâ€™s $sf$ is less than zero, it is determined to be a rule conflict. This indicates that due to the influence of the preceding rule, either the rule that is more inclined to the entity safety state was not executed for the latter rule, or the rule that contradicts the entity safety state was executed.
	\item For Action Interaction and Indirect Action Interaction, if either of the two rules has a non-zero safety value, it is determined to be a rule conflict. In this case, it should be noted that if both rules have safety values greater than zero, it will also be deemed a rule conflict, because in the determination of this type of rule interaction, the execution results of the two rules are contradictory, and typically only one rule needs to be executed.
\end{itemize}

%ç”±æ­¤å¯ä»¥å¯¹æ¯ç§è§„åˆ™è®¾å®šå¤šç§å¤„ç†ç­–ç•¥ã€‚å…·ä½“çš„å†²çªå¤„ç†ç­–ç•¥å¯ä»¥æ ¹æ®Table.\ref{Resolution_Policy_Decision}è¿›è¡Œé€‰æ‹©
Based on this, multiple resolution strategies can be set for each rule. The specific conflict resolution strategy can be selected according to Table.\ref{Resolution_Policy_Decision}.

\begin{table*}[htbp]
	\begin{center}
		\caption{Resolution Policy Decision (Need modification)}
		\label{Resolution_Policy_Decision}
		\begin{tabular}{c|c|c}
			\hline
			\textbf{Classification} & \textbf{Decision} & \textbf{Options} \\
			\hline
			\multirow{3}{*}{\textbf{Trigger Conflict} and \textbf{Indirect Trigger Conflict}} 
			& $(sf_2 = 0)\vee(sf_2>0 \wedge sf_1\geq 0)$ & Not rule conflict \\
			\cline{2-3}
			& $sf_1 < 0 \land sf_2 \geq 0$ & Only execute $R_2$ \\
			\cline{2-3}
			& $sf_2 < 0$ & Cancel execution of $R_2$ \\
			\hline
			\multirow{3}{*}{\textbf{Condition Conflict} and \textbf{Indirect Condition Conflict}} 
			& $(A_{1}\rightarrow C_{2}\wedge sf_{2}>0)\vee(A_{1}\nrightarrow C_{2}\wedge sf_{2}<0)$ & Not rule conflict \\
			\cline{2-3}
			& $A_{1}\rightarrow C_{2}\wedge sf_{2}>0$ & Do not execute $R_2$\\
			\cline{2-3}
			& $A_{1}\nrightarrow C_{2}\wedge sf_{2}<0$ & Execute $R_2$ \\
			\hline
			\multirow{6}{*}{\textbf{Action Conflict} and \textbf{Indirect Action Conflict}} 
			& $sf_1 = 0 \land sf_2 = 0$ & Not rule conflict \\
			\cline{2-3}
			& $sf_1 > 0 \land sf_2 < 0$ & Only execute $R_1$ \\
			\cline{2-3}
			& $sf_1 < 0 \land sf_2 > 0$ & Only execute $R_2$ \\
			\cline{2-3}
			& $sf_1 > 0 \land sf_2 > 0 \land sf_1 > sf_2$ & Both rules are executed, but ended with $R_1$ \\
			\cline{2-3}
			& $sf_1 > 0 \land sf_2 > 0 \land sf_1 < sf_2$ & Both rules are executed, but ended with $R_2$ \\
			\cline{2-3}
			& $sf_1 < 0 \land sf_2 < 0$ & Neither rule will be executed \\
			\hline
		\end{tabular}
	\end{center}
\end{table*}

\subsection{Dynamic Phase}
%å½“æ™ºèƒ½å®¶å±…ç³»ç»Ÿè¿è¡Œæ—¶ï¼Œè§„åˆ™äº‹ä»¶å°†è¢«å®žæ—¶ç›‘å¬ã€‚å½“ä¸€æ¡è§„åˆ™è¢«è§¦å‘ï¼Œåœ¨æ¡ä»¶æ£€æŸ¥é˜¶æ®µçš„å‰åŽéƒ½ä¼šè¿›è¡Œæ–­è¨€æ£€æµ‹æ¥åˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦å³å°†å‘ç”Ÿè§„åˆ™å†²çªã€‚æ–­è¨€æ£€æµ‹è¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¿¡æ¯éƒ½å°†é€šè¿‡ä»£ç æ’è£…æ¨¡å—è¿›è¡ŒèŽ·å–ï¼ŒåŒ…å«å½“å‰æ‰§è¡Œçš„è§„åˆ™ä¿¡æ¯ï¼Œè¿‡åŽ»æ‰§è¡Œçš„è§„åˆ™ä¿¡æ¯ï¼Œç›¸å…³å®žä½“è®¾å¤‡çš„å®žæ—¶çŠ¶æ€ä¸Žè¿‡åŽ»çŠ¶æ€å˜åŒ–ä¿¡æ¯ç­‰ã€‚
When the smart home system is running, rule events will be monitored in real-time. When a rule is triggered, assertion detection will be performed before and after the condition checking phase to determine whether a rule conflict is imminent. All information during the assertion detection process will be collected through the code instrumentation module, including the information of the currently executing rule, the information of the previously executed rule, the real-time status of related entities, and past state change information.

%æ–­è¨€æ£€æµ‹ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªå‡½æ•°ï¼š
Assertion detection mainly includes the following functions:

\begin{itemize}
	\item $obs()$: Observing the occurrence of an event (including the triggering of the trigger $obs(T)$,the passing of a condition check $obs(C)$, the failing of a condition check $obs(\neg C)$ and the execution of an action $obs(A)$
	\item $intime(X,Y,\delta)$: the time interval between events $X$ and $Y$ is less than $\delta$, with $\delta$ defaulting to 0.1 seconds
\end{itemize}

%ç”±æ­¤ï¼Œå¯¹äºŽä¸åŒç±»åž‹çš„è§„åˆ™å†²çªéƒ½æœ‰å¯¹åº”çš„æ–­è¨€æ£€æµ‹æ–¹æ³•ï¼Œå¦‚Table.\ref{Assertion_Verification}æ‰€ç¤ºã€‚
Accordingly, for different types of rule conflicts, there are corresponding assertion detection methods, as shown in Table.\ref{Assertion_Verification}.


\begin{table}[t]
		\caption{Assertion Verification Expression}
		\label{Assertion_Verification}
		\begin{adjustbox}{width=0.4\textwidth}
		\begin{tabular}[width=1\textwidth]{c|c|c}
			\hline
			\multicolumn{2}{c|}{\textbf{Classification}} & \textbf{Expression}\\
			\hline
			
			\multicolumn{2}{c|}{\textbf{Trigger Conflict}} &
			\makecell{
				$obs(T_1), obs(C_1), obs(A_1)$ \\
				$obs(T_2), obs(C_2)$ \\
				$intime(A_1, T_2, delta)$}\\
			\hline
			
			\multirow{2}{*}{\textbf{Condition Conflict}} & Make Conditions Forbidden &
			\makecell{$obs(C_2)$ \\
			$obs(T_1), obs(C_1), obs(A_1)$ \\
			$obs(\neg C_2)$ \\
			$intime(A_1, \neg C_2, delta)$} \\
			\cline{2-3}
			& Make Conditions Satisfied &
			\makecell{$obs(\neg C_2)$ \\
			$obs(T_1), obs(C_1), obs(A_1)$ \\
			$obs(C_2)$\\
			$intime(A_1, C_2, delta)$ }\\
			\hline
			
			\multicolumn{2}{c|}{\textbf{Action Conflict}} &
			\makecell{
				$obs(T_1), obs(C_1), obs(A_1)$ 
				\\ $obs(T_2), obs(C_2)$}\\
			\hline
			
			\multicolumn{2}{c|}{\textbf{Indirect Trigger Conflict}} &
			\makecell{$obs(T_1), obs(C_1), obs(A_1)$ \\
			$obs(T_2), obs(C_2)$} \\
			\hline
			
			\multirow{2}{*}{\textbf{Indirect Condition Conflict}} & Make Conditions Forbidden &
			\makecell{$obs(C_2)$ \\
			$obs(T_1), obs(C_1), obs(A_1)$ \\
			$obs(\neg C_2)$  \\
			$intime(A_1, \neg C_2, delta)$ }\\
			\cline{2-3}
			& Make Conditions Satisfied &
			\makecell{$obs(\neg C_2)$ \\
			$obs(T_1), obs(C_1), obs(A_1)$ \\
			$obs(C_2)$ \\
			$intime(A_1,  C_2, delta)$ }\\
			\hline
			
			\multicolumn{2}{c|}{\textbf{Indirect Action Conflict}}&
			\makecell{$obs(T_1), obs(C_1), obs(A_1)$ \\
				$obs(T_2), obs(C_2)$} \\
			\hline
			
		\end{tabular}
		\end{adjustbox}
\end{table}

%å½“æ–­è¨€æ£€æµ‹ç»“æžœè¡¨ç¤ºå½“å‰ç¡®å®žå³å°†å‘ç”Ÿå¯¹åº”äºŽæŸä¸€ç±»åž‹çš„æŸä¸€ä¸ªè§„åˆ™å†²çªæ—¶ï¼Œç³»ç»Ÿä¼šç«‹åˆ»æ‰§è¡Œå…¶å†²çªå¤„ç†ç­–ç•¥ã€‚å…·ä½“æ‰§è¡Œæ–¹å¼å¦‚ä¸‹ï¼šç³»ç»ŸæŸ¥çœ‹è§„åˆ™å†²çªå¯¹åº”çš„å†²çªå¤„ç†ç­–ç•¥ï¼Œç„¶åŽç”Ÿæˆå…·ä½“çš„æ‰§è¡ŒæŒ‡ä»¤ï¼Œäº¤ä»˜ç»™ä»£ç æ’è£…æ¨¡å—ã€‚ä»£ç æ’è£…æ¨¡å—å°†ä¼šå–æ¶ˆåŽŸæœ¬çš„è§„åˆ™è§¦å‘æ‰§è¡Œé€»è¾‘ï¼ˆå³è§¦å‘ã€æ¡ä»¶æ£€æµ‹ä¸Žæ‰§è¡Œï¼‰å¹¶å¼ºåˆ¶æ‰§è¡Œå¯¹åº”æŒ‡ä»¤ã€‚
When the assertion detection indicates that a rule conflict corresponding to a certain type is indeed imminent, the system will immediately execute its conflict resolution strategy. The specific implementation is as follows: the system reviews the conflict resolution strategy associated with the rule conflict, then generates specific execution commands and transmit them over to the code instrumentation module. The code instrumentation module will cancel the original rule-triggered execution logic (that is, triggering, condition checking, and action) and forcefully execute the corresponding commands.